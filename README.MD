# Edgerouter X Telia 6RD setup

## Description

Telia provides 6RD options by using IPv4 DHCP and "option-6rd" DHCP-option. By default, Ubiquiti Edgerouter does not query that option and adding it through the web GUI does not work. Therefore, DHCP-settings have to manually edited to perform the query.
Additionally, this repository provides a DHCP post-hook script, which setups the tunnel and firewall after the parameters have been acquired from the operator.

This project assumes that eth0 is the WAN-interface and switch0 is the LAN-interface.

This project relies on the work of Harry Sintonen and cpcowart. See references for their IPv6 RD projects.

### Known issues

* No DHCPv6 and therefore clients only get IPV6 addresses by SLAAC without any other options such as DNS-servers.
* Does not handle /56 particularly well, it works but is not the best solution as it assigns ::1/56 for the WAN interface and ::1/64 for the switch from the same prefix. Better solution would be choose a subnet for the WAN interface and use ::1/128 address, and choose another subnet for the switch and use ::1/64 for it.

## Setup

### Prequisites

Package ```ipv6calc``` is required for the DHCP-script.
Ubiquiti has a good description on how to add Debian packages to Edgerouter:
https://help.ubnt.com/hc/en-us/articles/205202560-EdgeRouter-Add-Debian-Packages-to-EdgeOS

### Process

Place the `option-6rd.sh` to `/etc/dhcp3/dhcp-exit-hooks.d/` -folder.
Modify `/run/dhclient_eth0.conf`.
Add the following to the beginning of the file 
```bash
option option-6rd code 212 = { integer 8, integer 8, integer 16, integer 16,
                               integer 16, integer 16, integer 16, integer 16,
			       integer 16, integer 16, array of ip-address };
```
Additionally, add `options-6rd` to the requests field.
Your `/run/dhclient_eth0.conf` should resemble the following example:

```bash
#
# autogenerated by vyatta-interfaces.pl on UTC Sat Jul 13 12:07:51 2019
#
option rfc3442-classless-static-routes code 121 = array of unsigned integer 8;
option option-6rd code 212 = { integer 8, integer 8, integer 16, integer 16,
                               integer 16, integer 16, integer 16, integer 16,
			       integer 16, integer 16, array of ip-address };

interface "eth0" {
        send host-name "hostname";
        request subnet-mask, broadcast-address, routers, domain-name-servers, domain-name, interface-mtu, option-6rd;
}
```

Run the following command to renew the DHCP-lease of the WAN-interface. You should now have a working 6RD tunnel with SLAAC configured for local addresses.
>sudo dhclient -cf /run/dhclient_eth0.conf eth0




## References

<https://sintonen.fi/debian-6rd/>

<https://github.com/cpcowart/ubiquiti-scripts/blob/master/centurylink-6rd.md>
